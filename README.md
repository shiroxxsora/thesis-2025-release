# Система обнаружения нарушений землепользования

Программное обеспечение для автоматического обнаружения и анализа нарушений землепользования на основе анализа спутниковых/аэрофотоснимков (GeoTIFF) с использованием машинного обучения (Detectron2) и кадастровых данных.

## Структура проекта

```
thesis-2025-release/
  ├── README.md                    # Эта инструкция
  ├── environment.yml              # Conda окружение
  ├── geotiff_processor.py         # Основной скрипт для инференса
  ├── fine_tuning_280625.py        # Скрипт для дообучения
  ├── finetune_model.py            # Базовый скрипт дообучения
  ├── train_model.py               # Полный скрипт обучения с нуля
  ├── models/
  │   └── pavel-01-07-25/
  │       └── model_final.pth      # Обученная модель (~480MB)
  ├── detectron2/
  │   └── configs/                 # Конфигурационные файлы Detectron2
  └── cadastr/
      ├── ЗУ все2.MIF              # Кадастровые границы (MIF формат)
      └── ЗУ все2.MID              # Кадастровые атрибуты (MID формат)
```

## Установка окружения (Linux, Python 3.10)

```bash
conda env create -f environment.yml
conda activate thesis-2025-env
```

## Решение проблем с установкой окружения

Если conda застревает на этапе "Solving environment" или возникают другие проблемы с зависимостями, используйте следующие рекомендации:

### Вариант 1: Очистить кэш conda
```bash
conda clean --all
conda env create -f environment.yml
```

### Вариант 2: Поэтапная установка (рекомендуется при сложных ошибках)
```bash
# Прервать процесс (Ctrl+C)
conda create -n thesis-2025-env python=3.10 -y
conda activate thesis-2025-env
conda install gdal rasterio shapely geopandas -c conda-forge -y
conda install numpy scipy opencv matplotlib pillow pyyaml tqdm cython pip -c conda-forge -y
pip install ninja pycocotools
pip install torch==2.7.1 --index-url https://download.pytorch.org/whl/cu118
pip install torchvision==0.22.1 --index-url https://download.pytorch.org/whl/cu118
pip install torchaudio==2.7.1 --index-url https://download.pytorch.org/whl/cu118
pip install git+https://github.com/facebookresearch/detectron2.git
```


### Проверка установки
```bash
conda activate thesis-2025-env
python -c "import torch; print(torch.__version__); print(torch.cuda.is_available())"
python -c "import detectron2; print(detectron2.__version__)"
python -c "import rasterio, geopandas; print('Геопакеты установлены')"
```


### Рекомендации
1. Очищайте кэш conda при проблемах: `conda clean --all`
2. Устанавливайте PyTorch отдельно от других пакетов
5. Устанавливайте геопакеты через conda-forge

## Использование

### Инференс (распознавание нарушений)

**Основной скрипт:** `geotiff_processor.py`

```bash
python geotiff_processor.py
```

Скрипт автоматически использует следующие пути:
- **Входной GeoTIFF:** `geotiffs/input.tiff` (поместите ваш файл сюда)
- **Модель:** `models/pavel-01-07-25/model_final.pth`
- **Конфиг:** `detectron2/configs/COCO-InstanceSegmentation/mask_rcnn_R_101_FPN_3x.yaml`
- **Кадастр:** `cadastr/ЗУ все2.MIF`

**Результаты сохраняются в папку `output_results/`:**
- `polygons_result.json` — все обнаруженные полигоны в GeoJSON
- `visualization_result.tif` — визуализация с наложением (GeoTIFF)
- `visualization_result.png` — то же самое в PNG с подписями площадей
- `blended_mask_all_detections.tif` — маска всех обнаружений
- `violation_analysis.json` — подробный анализ нарушений

### Обучение и дообучение

#### Дообучение на готовых датасетах (рекомендуется)
```bash
python fine_tuning_280625.py
```
- Использует последние и лучшие датасеты
- Быстрее полного обучения (~30-60 минут на GPU)
- Результат сохраняется в `output/finetuned_model_r101_2last/`

#### Базовое дообучение
```bash
python finetune_model.py
```

#### Полное обучение с нуля
```bash
python train_model.py
```
- Занимает несколько часов
- Результат в `output/`

## Алгоритм работы системы

### 1. Загрузка и подготовка данных
- Загружается входной GeoTIFF с геопривязкой
- Извлекается проекция и трансформация координат
- Изображение нормализуется для модели

### 2. Обнаружение объектов
- Изображение разбивается на перекрывающиеся чанки (5000×5000 пикселей с перекрытием 1536)
- Каждый чанк масштабируется до 1024×1024 и подается в модель Detectron2
- Получаются маски обнаруженных объектов
- Маски масштабируются обратно и объединяются

### 3. Обработка кадастровых данных
- Загружаются кадастровые границы из MIF/MID файлов
- Выполняется трансформация в систему координат растра
- Линии границ продлеваются до пересечения с другими линиями или краем изображения

### 4. Анализ нарушений
- Из общей маски обнаружений вычитаются кадастровые участки
- Получившиеся области разрезаются по продленным кадастровым границам
- Для каждого нарушения вычисляется площадь и привязка к участку

### 5. Создание результатов
- Генерируется визуализация с цветовой маркировкой
- Создается детальный отчет в JSON формате
- Сохраняются все промежуточные маски

## Форматы входных данных

### GeoTIFF
- **Формат:** GeoTIFF с корректной геопривязкой
- **Проекция:** Любая (будет автоматически обработана)
- **Размер:** До нескольких ГБ (обрабатывается по частям)
- **Каналы:** RGB или многоспектральные (используются первые 3)

### Кадастровые данные
- **Формат:** MIF/MID (MapInfo)
- **Содержимое:** Полигоны земельных участков
- **Проекция:** МСК-03 или любая другая (автоматическая трансформация)

## Настройка параметров

В файле `geotiff_processor.py` можно изменить:

```python
# Размер чанков для обработки (больше = быстрее, но больше памяти)
chunk_size = 5000

# Перекрытие между чанками (для избежания артефактов на границах)
overlap = 1536

# Порог достоверности модели (0.0-1.0)
score_thresh = 0.5

# Минимальная площадь нарушения (кв. метры)
min_violation_area_sqm = 1.5
```

## Результаты анализа

### Файл violation_analysis.json содержит:
- `total_violations` — общее количество нарушений
- `total_area_sqm` — общая площадь нарушений (кв. м)
- `total_area_hectares` — общая площадь нарушений (га)
- `individual_violations` — список каждого нарушения с площадью
- `total_detected_area_sqm` — общая площадь всех обнаруженных объектов
- `cadastral_area_sqm` — площадь кадастровых участков

### Цветовая схема визуализации:
- **Желтый (полупрозрачный)** — все обнаруженные объекты
- **Синий** — границы кадастровых участков
- **Красный** — области нарушений
- **Белые подписи** — площади нарушений в кв. метрах

## Технические требования

### Минимальные:
- CPU: 4 ядра, 2.5+ ГГц
- RAM: 16 ГБ
- GPU: 4+ ГБ VRAM (опционально)
- HDD: 10+ ГБ свободного места

### Рекомендуемые:
- CPU: 8+ ядер, 3.0+ ГГц
- RAM: 32+ ГБ
- GPU: NVIDIA RTX с 8+ ГБ VRAM
- SSD: 50+ ГБ
