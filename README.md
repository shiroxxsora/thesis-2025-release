# Система обнаружения нарушений землепользования

Программное обеспечение для автоматического обнаружения и анализа нарушений землепользования на основе анализа спутниковых/аэрофотоснимков (GeoTIFF) с использованием машинного обучения (Detectron2) и кадастровых данных.

## Структура папки release

```
release/
  ├── README.md                    # Эта инструкция
  ├── requirements.txt             # Зависимости Python
  ├── geotiff_processor.py         # Основной скрипт для инференса (распознавания)
  ├── fine_tuning_280625.py        # Скрипт для дообучения на последних датасетах
  ├── finetune_model.py            # Базовый скрипт дообучения
  ├── train_model.py               # Полный скрипт обучения с нуля
  ├── models/
  │   └── pavel-01-07-25/
  │       └── model_final.pth      # Обученная модель (~480MB)
  ├── detectron2/
  │   └── configs/                 # Конфигурационные файлы Detectron2
  └── cadastr/
      ├── ЗУ все2.MIF              # Кадастровые границы (MIF формат)
      └── ЗУ все2.MID              # Кадастровые атрибуты (MID формат)
```

## Установка зависимостей

### 1. Python и системные требования
- Python 3.8–3.10 (рекомендуется 3.9)
- CUDA 11.8+ (для GPU, опционально)
- Оперативная память: 16+ ГБ (для больших GeoTIFF)
- Место на диске: 10+ ГБ (включая модель и зависимости)

### 2. Установка PyTorch
**ВАЖНО: Установите PyTorch ПЕРВЫМ!**

Перейдите на https://pytorch.org/get-started/locally/ и выберите вашу конфигурацию:

```bash
# Для CUDA 12.1
pip install torch==2.7.1 torchvision==0.22.1 torchaudio==2.7.1 --index-url https://download.pytorch.org/whl/cu121

# Для CUDA 11.8
pip install torch==2.7.1 torchvision==0.22.1 torchaudio==2.7.1 --index-url https://download.pytorch.org/whl/cu118

# Для CPU (медленно, не рекомендуется)
pip install torch==2.7.1 torchvision==0.22.1 torchaudio==2.7.1
```

### 3. Установка остальных зависимостей
```bash
pip install -r requirements.txt
```

**На Windows:** Если возникают проблемы с GDAL, скачайте wheel файл с https://www.lfd.uci.edu/~gohlke/pythonlibs/#gdal

### 4. Проверка установки
```bash
python -c "import torch; print('PyTorch:', torch.__version__)"
python -c "import detectron2; print('Detectron2: OK')"
python -c "import rasterio; print('GDAL/Rasterio: OK')"
```

## Использование

### Инференс (распознавание нарушений)

**Основной скрипт:** `geotiff_processor.py`

```bash
python geotiff_processor.py
```

Скрипт автоматически использует следующие пути:
- **Входной GeoTIFF:** `geotiffs/input.tiff` (поместите ваш файл сюда)
- **Модель:** `models/pavel-01-07-25/model_final.pth`
- **Конфиг:** `detectron2/configs/COCO-InstanceSegmentation/mask_rcnn_R_101_FPN_3x.yaml`
- **Кадастр:** `cadastr/ЗУ все2.MIF`

**Результаты сохраняются в папку `output_results/`:**
- `polygons_result.json` — все обнаруженные полигоны в GeoJSON
- `visualization_result.tif` — визуализация с наложением (GeoTIFF)
- `visualization_result.png` — то же самое в PNG с подписями площадей
- `blended_mask_all_detections.tif` — маска всех обнаружений
- `violation_analysis.json` — подробный анализ нарушений

### Обучение и дообучение

#### Дообучение на готовых датасетах (рекомендуется)
```bash
python fine_tuning_280625.py
```
- Использует последние и лучшие датасеты
- Быстрее полного обучения (~30-60 минут на GPU)
- Результат сохраняется в `output/finetuned_model_r101_2last/`

#### Базовое дообучение
```bash
python finetune_model.py
```

#### Полное обучение с нуля
```bash
python train_model.py
```
- Занимает несколько часов
- Результат в `output/`

## Алгоритм работы системы

### 1. Загрузка и подготовка данных
- Загружается входной GeoTIFF с геопривязкой
- Извлекается проекция и трансформация координат
- Изображение нормализуется для модели

### 2. Обнаружение объектов
- Изображение разбивается на перекрывающиеся чанки (5000×5000 пикселей с перекрытием 1536)
- Каждый чанк масштабируется до 1024×1024 и подается в модель Detectron2
- Получаются маски обнаруженных объектов
- Маски масштабируются обратно и объединяются

### 3. Обработка кадастровых данных
- Загружаются кадастровые границы из MIF/MID файлов
- Выполняется трансформация в систему координат растра
- Линии границ продлеваются до пересечения с другими линиями или краем изображения

### 4. Анализ нарушений
- Из общей маски обнаружений вычитаются кадастровые участки
- Получившиеся области разрезаются по продленным кадастровым границам
- Для каждого нарушения вычисляется площадь и привязка к участку

### 5. Создание результатов
- Генерируется визуализация с цветовой маркировкой
- Создается детальный отчет в JSON формате
- Сохраняются все промежуточные маски

## Форматы входных данных

### GeoTIFF
- **Формат:** GeoTIFF с корректной геопривязкой
- **Проекция:** Любая (будет автоматически обработана)
- **Размер:** До нескольких ГБ (обрабатывается по частям)
- **Каналы:** RGB или многоспектральные (используются первые 3)

### Кадастровые данные
- **Формат:** MIF/MID (MapInfo)
- **Содержимое:** Полигоны земельных участков
- **Проекция:** МСК-03 или любая другая (автоматическая трансформация)

## Настройка параметров

В файле `geotiff_processor.py` можно изменить:

```python
# Размер чанков для обработки (больше = быстрее, но больше памяти)
chunk_size = 5000

# Перекрытие между чанками (для избежания артефактов на границах)
overlap = 1536

# Порог достоверности модели (0.0-1.0)
score_thresh = 0.5

# Минимальная площадь нарушения (кв. метры)
min_violation_area_sqm = 1.5
```

## Решение проблем

### PyTorch/CUDA
```bash
# Проверить версию CUDA
nvidia-smi

# Переустановить PyTorch под нужную CUDA
pip uninstall torch torchvision torchaudio
# Затем установить заново по инструкции выше
```

### GDAL (Windows)
```bash
# Если pip install gdal не работает
pip install GDAL-3.4.3-cp39-cp39-win_amd64.whl
# (скачать wheel с https://www.lfd.uci.edu/~gohlke/pythonlibs/)
```

### Память
- Уменьшите `chunk_size` до 3000-4000
- Закройте другие программы
- Используйте swap/виртуальную память

### Файлы не найдены
- Убедитесь, что файлы лежат в правильных папках
- Используйте абсолютные пути
- Проверьте права доступа к файлам

## Результаты анализа

### Файл violation_analysis.json содержит:
- `total_violations` — общее количество нарушений
- `total_area_sqm` — общая площадь нарушений (кв. м)
- `total_area_hectares` — общая площадь нарушений (га)
- `individual_violations` — список каждого нарушения с площадью
- `total_detected_area_sqm` — общая площадь всех обнаруженных объектов
- `cadastral_area_sqm` — площадь кадастровых участков

### Цветовая схема визуализации:
- **Желтый (полупрозрачный)** — все обнаруженные объекты
- **Синий** — границы кадастровых участков
- **Красный** — области нарушений
- **Белые подписи** — площади нарушений в кв. метрах

## Технические требования

### Минимальные:
- CPU: 4 ядра, 2.5+ ГГц
- RAM: 16 ГБ
- GPU: 4+ ГБ VRAM (опционально)
- HDD: 10+ ГБ свободного места

### Рекомендуемые:
- CPU: 8+ ядер, 3.0+ ГГц
- RAM: 32+ ГБ
- GPU: NVIDIA RTX с 8+ ГБ VRAM
- SSD: 50+ ГБ

## Описание параметров и переменных

Все основные параметры настраиваются в начале файла `geotiff_to_shp.py`:

- **INPUT_TIFF** — путь к входному GeoTIFF-файлу.
- **MODEL_CONFIG** — путь к конфигу нейросети.
- **MODEL_WEIGHTS** — путь к файлу весов модели.
- **OUTPUT_SHP** — путь для сохранения итогового Shapefile.
- **OUTPUT_KML** — путь для сохранения итогового KML.
- **SCORE_THRESH** — порог уверенности нейросети (0.0-1.0).
- **MIN_POLY_POINTS** — минимальное число точек в полигоне (упрощение).
- **MAX_POLY_POINTS** — максимальное число точек в полигоне (упрощение).
- **CHUNK_SIZE** — размер чанка для обработки больших изображений.
- **OVERLAP** — перекрытие между чанками.

### Как контролировать детализацию полигонов

- Для более гладких (простых) полигонов уменьшите `MAX_POLY_POINTS`.
- Для более точных (детализированных) полигонов увеличьте `MAX_POLY_POINTS`.
- `MIN_POLY_POINTS` не рекомендуется ставить меньше 3 (иначе не получится полигон).

## Визуальные схемы процессов

(Вставьте сюда схемы из предыдущих сообщений — например, в виде PNG или SVG, либо как текстовые блоки Mermaid)

## FAQ

- **Как изменить количество точек в полигоне?**  
  Измените параметры `MIN_POLY_POINTS` и `MAX_POLY_POINTS` в начале файла `geotiff_to_shp.py`.

- **Как получить KML?**  
  KML-файл формируется автоматически при запуске скрипта и сохраняется в папку `output/`.

- **Что делать, если мало объектов на выходе?**  
  Уменьшите `SCORE_THRESH` (например, до 0.3).

- **Что делать, если скрипт не видит файлы?**  
  Проверьте пути к файлам в переменных в начале скрипта.

## Алгоритмы работы (схемы)

### 1. Обучение модели с нуля

1. **Подготовьте датасет**:  
   - Соберите все изображения в одну папку (например, `Combined_Dataset/images/`).
   - Подготовьте файл аннотаций в формате COCO (например, `Combined_Dataset/annotations.json`).

2. **Запустите обучение**:  
   - Откройте терминал в папке `prerelease`.
   - Выполните команду:  
     `python train_model.py`

3. **Результат**:  
   - После завершения обучения файл весов модели будет сохранён, например, в `output_maskrcnn_r50/model_final.pth`.

---

### 2. Дообучение (fine-tuning) существующей модели

1. **Подготовьте новый датасет**:  
   - Создайте новую папку с изображениями и аннотациями (например, `dataset_280625/`).

2. **Запустите дообучение**:  
   - Убедитесь, что у вас есть файл весов предыдущей модели (`model_final.pth`).
   - Откройте терминал в папке `prerelease`.
   - Выполните команду:  
     `python fine_tuning_280625.py`

3. **Результат**:  
   - После завершения дообучения обновлённый файл весов будет сохранён в папке, например, `output/finetuned_model_r101_280625/model_final.pth`.

---

### 3. Инференс и экспорт результатов

1. **Подготовьте входные данные**:  
   - Поместите ваш GeoTIFF-файл в папку `geotiffs/` или укажите путь к нему в переменной `INPUT_TIFF` в начале файла `geotiff_to_shp.py`.
   - Убедитесь, что путь к файлу весов модели (`MODEL_WEIGHTS`) указан верно.

2. **Запустите инференс**:  
   - Откройте терминал в папке `prerelease`.
   - Выполните команду:  
     `python geotiff_to_shp.py`

3. **Результат**:  
   - В папке `output/` появятся файлы:
     - `polygons_from_mask.shp` — полигоны для QGIS/ArcGIS.
     - `polygons_from_mask.kml` — полигоны для Google Earth.

---

**Примечание:**  
Все параметры (пути к файлам, пороги, детализация полигонов и др.) настраиваются в начале соответствующих скриптов.  
Подробное описание переменных — в разделе "Описание параметров и переменных".
