# Инструкция по использованию системы обнаружения нарушений землепользования

## Описание системы

Система предназначена для автоматического обнаружения фактических границ земельных участков на снимках с дрона и выявления нарушений землепользования путем сравнения с кадастровыми данными. Использует нейронные сети (Detectron2) для сегментации объектов и геопространственный анализ для определения нарушений.

## Варианты использования

### 1. БАЗОВОЕ ИСПОЛЬЗОВАНИЕ (Анализ готовой моделью)

**Назначение:** Быстрый анализ нарушений на вашем снимке с помощью предобученной модели

**Этапы:**

#### 1.1 Настройка окружения
```bash
# Установка зависимостей
conda env create -f environment.yml
conda activate thesis-2025-env

# Проверка установки
python -c "import torch; print('PyTorch:', torch.__version__)"
python -c "import detectron2; print('Detectron2 установлен')"
```

#### 1.2 Подготовка данных
- Поместите ваш GeoTIFF файл в папку `geotiffs/` с именем `input.tiff`
- Убедитесь, что файл имеет корректную геопривязку
- Поддерживаются проекции: МСК, UTM, любые другие

#### 1.3 Запуск анализа
```bash
python geotiff_processor.py
```

#### 1.4 Получение результатов
После выполнения в папке `output_results/` будут созданы:
- `polygons_result.json` - координаты всех обнаруженных объектов
- `violation_analysis.json` - анализ нарушений с площадями
- `visualization_result.png` - карта с выделенными нарушениями
- `visualization_result.tif` - геопривязанная визуализация

### 2. ЭКСПОРТ В ГИС ФОРМАТЫ

**Назначение:** Создание файлов для импорта в ArcGIS, QGIS и другие ГИС-системы

**Этапы:**

#### 2.1 Подготовка данных
- Используйте тот же файл `geotiffs/input.tiff`

#### 2.2 Запуск экспорта
```bash
python geotiff_to_shp.py
```

#### 2.3 Результаты экспорта
В папке `output/` будут созданы:
- `polygons_from_mask.shp` - Shapefile для импорта в ГИС
- `polygons_from_mask.kml` - KML для Google Earth/Maps

### 3. ОБУЧЕНИЕ СОБСТВЕННОЙ МОДЕЛИ

**Назначение:** Адаптация системы под специфические условия вашего региона

#### 3.1 Быстрое дообучение (рекомендуется, предварительн осоставить датасет)
```bash
python fine_tuning_280625.py
```
- Время выполнения: 30-60 минут
- Использует готовые размеченные данные
- Результат сохраняется в `output/finetuned_model_r101_2last/`

#### 3.2 Полное обучение с нуля
```bash
python train_model.py
```
- Время выполнения: 3-6 часов
- Требует подготовленные данные в папке `Combined_Dataset/` (или другой, настраивается в скрипте)
- Результат сохраняется в `output/`

#### 3.3 Использование новой модели
Измените в файле `geotiff_processor.py`:
```python
'model_weights': "путь/до/вашей/модели"
```

## Методика работы системы

### Этап 1: Обнаружение объектов
1. Загрузка GeoTIFF файла с сохранением геопривязки
2. Разбиение большого изображения на фрагменты (5000×5000 пикселей)
3. Обработка каждого фрагмента нейронной сетью Detectron2
4. Объединение результатов в единую маску

### Этап 2: Анализ кадастровых данных
1. Загрузка кадастровых границ из MIF/MID файлов
2. Трансформация координат в систему координат растра
3. Растеризация кадастровых полигонов

### Этап 3: Выявление нарушений
1. Вычитание кадастровых участков из обнаруженных объектов
2. Разрезание нарушений по продленным кадастровым границам
3. Вычисление площадей нарушений
4. Фильтрация мелких объектов (менее 1.5 м², настраивается )

### Этап 4: Формирование результатов
1. Создание визуализации с цветовой кодировкой
2. Экспорт в различные форматы (JSON, GeoTIFF, Shapefile)
3. Генерация отчета с площадями нарушений

## Настройка параметров

### Основные параметры в geotiff_processor.py:

```python
# Размер обрабатываемого фрагмента
'chunk_size': 5000,  # Уменьшите при нехватке памяти

# Порог уверенности модели
'score_threshold': 0.5,  # Понизьте для обнаружения большего количества объектов

# Минимальная площадь нарушения
'min_violation_area': 1.5,  # кв.м
```

### Пути к файлам:
```python
# Входной GeoTIFF
'input_geotiff': "geotiffs/input.tiff",

# Кадастровые данные
'cadastral_data': "cadastr/ЗУ все2.MIF",

# Модель
'model_weights': "models/pavel-01-07-25/model_final.pth"
```

## Требования к данным

### GeoTIFF файлы:
- Обязательная геопривязка
- Поддерживаемые проекции: МСК, UTM, географические
- Разрешение: любое (оптимально 0.5-2 м/пиксель)
- Размер: до нескольких ГБ

### Кадастровые данные:
- Формат: MIF/MID (MapInfo)
- Содержимое: полигоны земельных участков
- Система координат: любая (автоматическая трансформация)

## Интерпретация результатов

### Файл violation_analysis.json:
- `total_violations` - общее количество нарушений
- `total_area_sqm` - общая площадь нарушений в кв.м
- `total_area_hectares` - общая площадь нарушений в гектарах
- `individual_violations` - список отдельных нарушений

### Визуализация:
- **Желтые области** - все обнаруженные объекты
- **Красные области** - нарушения землепользования
- **Синие линии** - кадастровые границы
- **Белые цифры** - площади нарушений в кв.м

## Устранение проблем

### Проблема: "Не удалось определить проекцию"
**Решение:** Убедитесь, что GeoTIFF имеет корректную геопривязку. Используйте QGIS для проверки.

### Проблема: "Не хватает памяти GPU"
**Решение:** Уменьшите `chunk_size` в настройках или используйте CPU:
```python
cfg.MODEL.DEVICE = "cpu"
```

### Проблема: "Слишком много/мало обнаружений"
**Решение:** Настройте `score_threshold`:
- Увеличьте для меньшего количества объектов
- Уменьшите для большего количества объектов 

Или попробуйте дообучить модель на новых данных

## Технические требования

### Минимальные(нерекомендуется, будет задействован файл подкачки и CPU):
- CPU: 4 ядра, 16 ГБ RAM, файл подкачки (32+ ГБ)
- GPU: не обязательно (может работать на CPU)
- Место: 10 ГБ свободного пространства

### Рекомендуемые:
- CPU: 8+ ядер, 32+ ГБ RAM
- GPU: NVIDIA с 8+ ГБ VRAM
- Место: 50+ ГБ свободного пространства
- SSD диск для быстрой обработки

## Время выполнения

- **Анализ участка 1 км²**: 5-15 минут
- **Дообучение модели**: 30-60 минут
- **Полное обучение**: 3-6 часов

*Время указано для современного GPU. На CPU работа займет в 3-5 раз больше времени.* 